

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>dataio.dataio &mdash; fmu.dataio 0.4.1.dev5+g0af3599 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/togglebutton.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #C0C0C0" >
          

          
            <a href="../../index.html" class="icon icon-home"> fmu.dataio
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apiref/modules.html">API reference for fmu.dataio</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">fmu.dataio</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>dataio.dataio</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for dataio.dataio</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module for DataIO class.</span>

<span class="sd">The metadata spec is presented in</span>
<span class="sd">https://github.com/equinor/fmu-metadata/</span>

<span class="sd">The processing is based on handling first level keys which are</span>

<span class="sd">* Scalar special::</span>

<span class="sd">    $schema      |</span>
<span class="sd">    version      |     hard set in code</span>
<span class="sd">    source       |</span>

<span class="sd">* ``class``        - determined by datatype, inferred</span>

<span class="sd">* Nested attributes::</span>

<span class="sd">    file         - file paths and checksums (change) still a discussion where to be</span>
<span class="sd">    tracklog     - data events, source = ?</span>
<span class="sd">    data         - about the data (see class). Inferred from data + fmuconfig</span>
<span class="sd">    display      - Deduced mostly from fmuconfig (TODO: issue on wait)</span>
<span class="sd">    fmu          - Deduced from fmuconfig (and ERT run?)</span>
<span class="sd">    access       - Static, infer from fmuconfig</span>
<span class="sd">    masterdata   - Static, infer from fmuconfig</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">getpass</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">from</span> <span class="nn">._export_item</span> <span class="kn">import</span> <span class="n">_ExportItem</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_utils</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>

<span class="c1"># the word &quot;DOLLARS&quot; refers losely to $schema and related keys (version, source)</span>
<span class="n">DOLLARS</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span>
            <span class="s2">&quot;$schema&quot;</span><span class="p">,</span>
            <span class="s2">&quot;https://main-fmu-schemas-dev.radix.equinor.com/schemas/0.8.0/&quot;</span>
            <span class="s2">&quot;fmu_results.json&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;version&quot;</span><span class="p">,</span>
            <span class="s2">&quot;0.8.0&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;source&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fmu&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="c1"># ######################################################################################</span>
<span class="c1"># ExportData</span>
<span class="c1"># ######################################################################################</span>


<div class="viewcode-block" id="ExportData"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.ExportData">[docs]</a><span class="k">class</span> <span class="nc">ExportData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class for exporting data with rich metadata in FMU.&quot;&quot;&quot;</span>

    <span class="n">surface_fformat</span> <span class="o">=</span> <span class="s2">&quot;irap_binary&quot;</span>
    <span class="n">table_fformat</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>
    <span class="n">polygons_fformat</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>
    <span class="n">grid_fformat</span> <span class="o">=</span> <span class="s2">&quot;roff&quot;</span>
    <span class="n">export_root</span> <span class="o">=</span> <span class="s2">&quot;../../share/results&quot;</span>
    <span class="n">case_folder</span> <span class="o">=</span> <span class="s2">&quot;share/metadata&quot;</span>  <span class="c1"># e.g. /some_rootpath/case/metadata</span>
    <span class="n">createfolder</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">meta_format</span> <span class="o">=</span> <span class="s2">&quot;yaml&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">relation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tagname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">vertical_domain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timedata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">is_prediction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">is_observation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">workflow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">grid_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">access_ssdl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">runfolder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CRITICAL&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Instantate ExportData object.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the object. If not set it is tried to be inferred from</span>
<span class="sd">                the xtgeo/pandas/... object. The name is then checked towards the</span>
<span class="sd">                stratigraphy list, and name is replaced with official stratigraphic</span>
<span class="sd">                name if found in stattic metadata `stratigraphy`. For example, if</span>
<span class="sd">                &quot;TopValysar&quot; is the model name and the actual name</span>
<span class="sd">                is &quot;Valysar Top Fm.&quot; that latter name will be used.</span>
<span class="sd">            relation: [EXPERIMENTAL] The relation of the object with respect to</span>
<span class="sd">                itself and/or other stratigraphic units. The default is None, but for</span>
<span class="sd">                e.g. seismic attributes this can be important. The input is a</span>
<span class="sd">                dictionary with the following fields: [TODO]</span>
<span class="sd">            config: A configuation dictionary. In the standard case this is read</span>
<span class="sd">                from FMU global variables (via fmuconfig). The dictionary must contain</span>
<span class="sd">                some predefined main level keys to work with fmu-dataio.</span>
<span class="sd">            content: Is a string or a dictionary with one key. Example is &quot;depth&quot; or</span>
<span class="sd">                {&quot;fluid_contact&quot;: {&quot;xxx&quot;: &quot;yyy&quot;, &quot;zzz&quot;: &quot;uuu&quot;}}</span>
<span class="sd">            unit: Is the unit of the exported item(s), e.g. &quot;m&quot; or &quot;fraction&quot;.</span>
<span class="sd">            tagname: This is a short tag description which be be a part of file name</span>
<span class="sd">            vertical_domain: This is dictionary with a key and a reference e.g.</span>
<span class="sd">                {&quot;depth&quot;: &quot;msl&quot;} which is default (if None is input)</span>
<span class="sd">            timedata: If given, a list of lists with dates, .e.g.</span>
<span class="sd">                [[20200101, &quot;firsttime&quot;], [20180101, &quot;secondtime&quot;]] or just [[20210101]]</span>
<span class="sd">            is_prediction: True (default) of model prediction data</span>
<span class="sd">            is_observation: Default is False.</span>
<span class="sd">            workflow: Short tag desciption of workflow (as description)</span>
<span class="sd">            description: A multiline desciption of the data</span>
<span class="sd">            access_ssdl: A dictionary that will overwrite the default ssdl</span>
<span class="sd">                settings read from the config. Example:</span>
<span class="sd">                ``{&quot;access_level&quot;: &quot;restricted&quot;, &quot;rep_include&quot;: False}``</span>
<span class="sd">            runfolder: Set toplevel of runfolder, where default is current directory</span>
<span class="sd">            verbosity: Is logging/message level for this module. Input as</span>
<span class="sd">                in standard python logging; e.g. &quot;WARNING&quot;, &quot;INFO&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relation</span> <span class="o">=</span> <span class="n">relation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unit</span> <span class="o">=</span> <span class="n">unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tagname</span> <span class="o">=</span> <span class="n">tagname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timedata</span> <span class="o">=</span> <span class="n">timedata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vertical_domain</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="s2">&quot;msl&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">vertical_domain</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">vertical_domain</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_prediction</span> <span class="o">=</span> <span class="n">is_prediction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_observation</span> <span class="o">=</span> <span class="n">is_observation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span> <span class="o">=</span> <span class="n">workflow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_access_ssdl</span> <span class="o">=</span> <span class="n">access_ssdl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span> <span class="o">=</span> <span class="n">verbosity</span>

        <span class="c1"># keep track if case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># store iter and realization folder names (when running ERT)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iterfolder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_realfolder</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Create instance of ExportData&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">runfolder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">runfolder</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

        <span class="c1"># define chunks of metadata for primary first order categories</span>
        <span class="c1"># (except class which is set directly later)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_strat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_dollars</span> <span class="o">=</span> <span class="n">DOLLARS</span>  <span class="c1"># schema, version, source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_file</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># file (to be populated in export job)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_tracklog</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># tracklog:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># data:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_display</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># display:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_access</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># access:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_masterdata</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># masterdata:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fmu</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># fmu:</span>

        <span class="c1"># strat metadata are used as componenents in some of the other meta keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_strat</span><span class="p">()</span>

        <span class="c1"># Get the metadata for some of the general stuff, fully or partly</span>
        <span class="c1"># Note that data are found later (e.g. in _export_item)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_masterdata</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_access</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_tracklog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_fmu</span><span class="p">()</span>

    <span class="c1"># ==================================================================================</span>
    <span class="c1"># Private metadata methods which retrieve metadata that are not closely linked to</span>
    <span class="c1"># the actual instance to be exported.</span>

    <span class="k">def</span> <span class="nf">_get_meta_masterdata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get metadata from masterdata section in config.</span>

<span class="sd">        Having the `masterdata` as hardcoded first level in the config is intentional.</span>
<span class="sd">        If that section is missing, or config is None, return with a user warning.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s2">&quot;masterdata&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No masterdata section present&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_masterdata</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_masterdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;masterdata&quot;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata for masterdata is set!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_meta_access</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get metadata overall (default) from access section in config.&quot;&quot;&quot;</span>
        <span class="c1"># note that access should be possible to change per object</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s2">&quot;access&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No access section present&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_access</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_access</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata for access is set!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_meta_tracklog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get metadata for tracklog section.&quot;&quot;&quot;</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()}</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;event&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;created&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_tracklog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata for tracklog is set&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_meta_fmu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get metadata for fmu key.</span>

<span class="sd">        The fmu block consist of these subkeys:</span>
<span class="sd">            model:</span>
<span class="sd">            case:</span>
<span class="sd">            workflow:</span>
<span class="sd">            element:  # if aggadation</span>
<span class="sd">            realization OR aggradation:</span>
<span class="sd">            iteration:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set fmu metadata for model/workflow/...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fmu</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_meta_fmu_model</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set fmu.workflow...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fmu</span><span class="p">[</span><span class="s2">&quot;workflow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fmu</span><span class="p">[</span><span class="s2">&quot;workflow&quot;</span><span class="p">][</span><span class="s2">&quot;refence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fmu</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">c_meta</span><span class="p">,</span> <span class="n">i_meta</span><span class="p">,</span> <span class="n">r_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_meta_fmu_realization_iteration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fmu</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fmu</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fmu</span><span class="p">[</span><span class="s2">&quot;realization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_meta</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata for realization/iteration/case is parsed!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r_meta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Note that metadata for realization is None, &quot;</span>
                <span class="s2">&quot;so this is interpreted as not an ERT run!&quot;</span>
            <span class="p">)</span>

        <span class="c1"># self._meta_fmu[&quot;grid_model&quot;] = self._process_meta_fmu_grid_model()</span>

    <span class="k">def</span> <span class="nf">_process_meta_fmu_grid_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Processing the fmu:grid_model section&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;grid_model was None, assuming it was not passed&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_model</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;grid_model: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">meta</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;grid_model type was </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">meta</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The grid_model argument must be of type dict&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;grid_model: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">meta</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;keys in meta: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;grid_model must contain &#39;name&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">_gmname</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>  <span class="c1"># shortform</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;grid_model: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">_gmname</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;grid_model:name was of type </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">_gmname</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;grid_model:name must be a string&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;grid_model section has been processed&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">meta</span>

    <span class="k">def</span> <span class="nf">_process_meta_fmu_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Processing the fmu:model section.&quot;&quot;&quot;</span>

        <span class="c1"># most of the info from global variables section model:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>

        <span class="c1"># the model section in &quot;template&quot; contains root etc. For revision an</span>
        <span class="c1"># AUTO name may be used to avoid rapid and error-prone naming</span>
        <span class="n">revision</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;revision&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">revision</span> <span class="o">==</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">:</span>
            <span class="n">rev</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">folders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span>
            <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="o">.</span><span class="n">parents</span><span class="p">)):</span>
                <span class="n">realfoldername</span> <span class="o">=</span> <span class="n">folders</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">num</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

                <span class="c1"># match 20.1.xxx style or r003 style</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[123][0-9]</span><span class="se">\\</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">realfoldername</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="s2">&quot;^[r][0-9][0-9][0-9]&quot;</span><span class="p">,</span> <span class="n">realfoldername</span>
                <span class="p">):</span>
                    <span class="n">rev</span> <span class="o">=</span> <span class="n">realfoldername</span>
                    <span class="k">break</span>

            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;revision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rev</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got metadata for fmu:model&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">meta</span>

    <span class="k">def</span> <span class="nf">_process_meta_fmu_realization_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Detect if this is a realization run.</span>

<span class="sd">        To detect if a realization run:</span>
<span class="sd">        * See of parameters.txt json at iter level</span>
<span class="sd">        * find iter name and realization number from folder names</span>

<span class="sd">        e.g.</span>
<span class="sd">        /scratch/xxx/user/case/realization-11/iter-3</span>

<span class="sd">        The iter folder may have other names, like &quot;pred&quot; which is fully</span>
<span class="sd">        supported. Then iter number (id) shall be 0.</span>

<span class="sd">        Will also parse the fmu.case metadata block from file which is stored</span>
<span class="sd">        higher up and generated in-advance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Process metadata for realization and iteration&quot;</span><span class="p">)</span>
        <span class="n">is_fmurun</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">folders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Folder to evaluate: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span><span class="p">)</span>
        <span class="n">therealization</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ertjob</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="n">iterfolder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">casefolder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">userfolder</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="o">.</span><span class="n">parents</span><span class="p">)):</span>
            <span class="n">foldername</span> <span class="o">=</span> <span class="n">folders</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">num</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^realization-.&quot;</span><span class="p">,</span> <span class="n">foldername</span><span class="p">):</span>
                <span class="n">is_fmurun</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">realfolder</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
                <span class="n">iterfolder</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">casefolder</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">userfolder</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Realization folder is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">realfolder</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Iter folder is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">iterfolder</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Case folder is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">casefolder</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;User folder is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">userfolder</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_iterfolder</span> <span class="o">=</span> <span class="n">iterfolder</span><span class="o">.</span><span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_realfolder</span> <span class="o">=</span> <span class="n">realfolder</span><span class="o">.</span><span class="n">name</span>

                <span class="n">therealization</span> <span class="o">=</span> <span class="n">realfolder</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;realization-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="c1"># store parameters.txt and jobs.json</span>
                <span class="n">parameters_file</span> <span class="o">=</span> <span class="n">iterfolder</span> <span class="o">/</span> <span class="s2">&quot;parameters.txt&quot;</span>
                <span class="k">if</span> <span class="n">parameters_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">read_parameters_txt</span><span class="p">(</span><span class="n">parameters_file</span><span class="p">)</span>
                    <span class="n">ertjob</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span>

                <span class="n">jobs_file</span> <span class="o">=</span> <span class="n">iterfolder</span> <span class="o">/</span> <span class="s2">&quot;jobs.json&quot;</span>
                <span class="k">if</span> <span class="n">jobs_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jobs_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
                        <span class="n">ertjob</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_fmurun</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># ------------------------------------------------------------------------------</span>
        <span class="c1"># get the case metadata which shall be established already</span>
        <span class="n">casemetaroot</span> <span class="o">=</span> <span class="n">casefolder</span> <span class="o">/</span> <span class="s2">&quot;share&quot;</span> <span class="o">/</span> <span class="s2">&quot;metadata&quot;</span> <span class="o">/</span> <span class="s2">&quot;fmu_case&quot;</span>
        <span class="c1"># may be json or yml</span>
        <span class="n">casemetafile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;.yml&quot;</span><span class="p">):</span>
            <span class="n">casemetafile</span> <span class="o">=</span> <span class="n">casemetaroot</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">casemetafile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">casemetafile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find any case metafile! </span><span class="si">{</span><span class="n">casemetafile</span><span class="si">}</span><span class="s2">.*&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read existing case metadata from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">casemetafile</span><span class="p">))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">casemetafile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">inmeta</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>  <span class="c1"># will read json also?</span>

        <span class="n">c_meta</span> <span class="o">=</span> <span class="n">inmeta</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>

        <span class="c1"># ------------------------------------------------------------------------------</span>
        <span class="c1"># get the iteration metadata</span>
        <span class="n">runid</span> <span class="o">=</span> <span class="n">ertjob</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">][</span><span class="s2">&quot;run_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">i_meta</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">i_meta</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">uuid_from_string</span><span class="p">(</span><span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">iterfolder</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">i_meta</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s2">&quot;iter-&quot;</span> <span class="ow">in</span> <span class="n">iterfolder</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">i_meta</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iterfolder</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;iter-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">i_meta</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iterfolder</span><span class="o">.</span><span class="n">name</span>
        <span class="n">i_meta</span><span class="p">[</span><span class="s2">&quot;runid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runid</span>

        <span class="c1"># ------------------------------------------------------------------------------</span>
        <span class="c1"># get the realization metadata</span>
        <span class="n">r_meta</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">r_meta</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">therealization</span><span class="p">)</span>
        <span class="n">r_meta</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">realfolder</span><span class="o">.</span><span class="n">name</span>
        <span class="n">r_meta</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">uuid_from_string</span><span class="p">(</span>
            <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_meta</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">r_meta</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">r_meta</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ertjob</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span>
        <span class="n">r_meta</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ertjob</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got metadata for fmu:realization&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Case meta: </span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">c_meta</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Iteration meta: </span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">i_meta</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Realiz. meta: </span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">r_meta</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">c_meta</span><span class="p">,</span> <span class="n">i_meta</span><span class="p">,</span> <span class="n">r_meta</span>

    <span class="k">def</span> <span class="nf">_get_meta_strat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get metadata from the stratigraphy block in config; used indirectly.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Config is missing, not possible to parse stratigraphy&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_strat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="s2">&quot;stratigraphy&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not possible to parse the stratigraphy section&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_strat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_strat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;stratigraphy&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata for stratigraphy is parsed!&quot;</span><span class="p">)</span>

    <span class="c1"># ==================================================================================</span>
    <span class="c1"># Public methods</span>

<div class="viewcode-block" id="ExportData.to_file"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.ExportData.to_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Export a &#39;known&#39; data object to FMU file with rich metadata.</span>

<span class="sd">        The &#39;known&#39; datatype is a XTGeo object (e.g. a RegularSurface), a Pandas</span>
<span class="sd">        Dataframe or (in future) a Arrow object.</span>

<span class="sd">        This function will also collect the data spesific class metadata. For &quot;classic&quot;</span>
<span class="sd">        files, the metadata will be stored i a YAML file with same name stem as the</span>
<span class="sd">        data, but with a . in front and &quot;yml&quot; and suffix, e.g.::</span>

<span class="sd">            top_volantis--depth.gri</span>
<span class="sd">            .top_volantis--depth.gri.yml</span>

<span class="sd">        For HDF files the metadata may be stored on the _freeform_ block (yet to be</span>
<span class="sd">        resolved)).</span>

<span class="sd">        Args:</span>
<span class="sd">            obj: XTGeo instance or a pandas instance (more to be supported).</span>
<span class="sd">            subfolder: Optional subfolder below standard level to export to.</span>
<span class="sd">            verbosity: Verbosity level of logging messages. If not spesified,</span>
<span class="sd">                use the verbosity level from the instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            String path (relative path) to exported file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Export to file...&quot;</span><span class="p">)</span>
        <span class="n">exporter</span> <span class="o">=</span> <span class="n">_ExportItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exporter</span><span class="o">.</span><span class="n">save_to_file</span><span class="p">())</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span></div></div>


<span class="c1"># ######################################################################################</span>
<span class="c1"># InitializeCase</span>
<span class="c1"># ######################################################################################</span>
<div class="viewcode-block" id="InitializeCase"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.InitializeCase">[docs]</a><span class="k">class</span> <span class="nc">InitializeCase</span><span class="p">(</span><span class="n">ExportData</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-few-public-methods</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># pylint: disable=super-init-not-called</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CRITICAL&quot;</span><span class="p">,</span>
        <span class="n">runfolder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Instantate ExportData object.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: A configuation dictionary. In the standard case this is read</span>
<span class="sd">                from FMU global vaiables (via fmuconfig). The dictionary must contain</span>
<span class="sd">                some predefined main level keys.</span>
<span class="sd">            verbosity: Is logging/message level for this module. Input as</span>
<span class="sd">                in standard python logging; e.g. &quot;WARNING&quot;, &quot;INFO&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span> <span class="o">=</span> <span class="n">verbosity</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Create instance of InitializeCase&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">runfolder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">runfolder</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

        <span class="c1"># define chunks of metadata for primary first order categories</span>
        <span class="c1"># (except class which is set directly later)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_strat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_dollars</span> <span class="o">=</span> <span class="n">DOLLARS</span>  <span class="c1"># schema, version, source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_file</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># file (to be populated in export job)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_tracklog</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># tracklog:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># data:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_display</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># display:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_access</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># access:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_masterdata</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># masterdata:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fmu</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># fmu:</span>

        <span class="c1"># strat metadata are used as componenents in some of the other meta keys</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_meta_strat</span><span class="p">()</span>

        <span class="c1"># Get the metadata for some of the general stuff, fully or partly</span>
        <span class="c1"># Note that data are found later (e.g. in _export_item)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_meta_masterdata</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_meta_access</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_meta_tracklog</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_meta_fmu</span><span class="p">()</span>

    <span class="c1"># ==================================================================================</span>
    <span class="c1"># Store case data.</span>

    <span class="k">def</span> <span class="nf">_store_case_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">casefolder</span><span class="p">,</span> <span class="n">c_meta</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c_meta</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Storing case metadata...&quot;</span><span class="p">)</span>
        <span class="n">case_meta_exists</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">share_caseroot</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">casefolder</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">share_caseroot</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The metadata folder root exists already: &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The metadata folder root is created: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">share_caseroot</span><span class="p">))</span>

        <span class="n">metafile</span> <span class="o">=</span> <span class="n">share_caseroot</span> <span class="o">/</span> <span class="s2">&quot;fmu_case.yml&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Case metadata file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metafile</span><span class="p">))</span>

        <span class="n">existing_metadata</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">metafile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Case metadata file already exists. So parsing it.&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metafile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
                <span class="n">existing_metadata</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">existing_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reusing fmu.case.uuid&quot;</span><span class="p">)</span>
            <span class="n">fmu_case_uuid</span> <span class="o">=</span> <span class="n">existing_metadata</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;case&quot;</span><span class="p">][</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating fresh fmu.case.uuid&quot;</span><span class="p">)</span>
            <span class="n">fmu_case_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;fmu.case.uuid is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fmu_case_uuid</span><span class="p">)</span>
        <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmu_case_uuid</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_dollars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;case&quot;</span>

        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_meta</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fmu</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>

        <span class="c1"># Should not be possible to initialize a case without</span>
        <span class="c1"># the access.asset field be present.</span>
        <span class="c1"># Outgoing case metadata should contain access.asset only</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_access</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;self._meta_access is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta_access</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot proceed without access information.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Access information missing.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;asset&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_access</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;the access field in the metadata was missing the asset field&quot;</span><span class="p">)</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;asset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_access</span><span class="p">[</span><span class="s2">&quot;asset&quot;</span><span class="p">]}</span>

        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;masterdata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_masterdata</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;tracklog&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="n">track</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="n">track</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">track</span><span class="p">[</span><span class="s2">&quot;event&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;created&quot;</span>
        <span class="n">track</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">track</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;tracklog&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>

        <span class="c1"># in case the file is deleted but the folder exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metafile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Case metafile is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metafile</span><span class="p">))</span>
            <span class="n">case_meta_exists</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">case_meta_exists</span><span class="p">:</span>
            <span class="c1"># collect needed metadata and save to disk</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Create case metadata as </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metafile</span><span class="p">))</span>
            <span class="n">_utils</span><span class="o">.</span><span class="n">export_metadata_file</span><span class="p">(</span>
                <span class="n">metafile</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span><span class="p">,</span> <span class="n">savefmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_format</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Metadata case file already exists for the case!: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">metafile</span>
            <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_establish_fmu_case_metadata</span><span class="p">(</span>
        <span class="n">casename</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
        <span class="n">caseuser</span><span class="o">=</span><span class="s2">&quot;nn&quot;</span><span class="p">,</span>
        <span class="n">restart_from</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Establish the fmu.case card.&quot;&quot;&quot;</span>
        <span class="n">c_meta</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c1"># iterfolder something like /scratch/xxx/user/casename/iter-0</span>

        <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">casename</span>
        <span class="c1"># uuid is inserted at later stage</span>
        <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseuser</span>
        <span class="k">if</span> <span class="n">restart_from</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;restart_from&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">restart_from</span>
        <span class="n">timeid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Generated by </span><span class="si">{</span><span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">timeid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">c_meta</span>

<div class="viewcode-block" id="InitializeCase.to_file"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.InitializeCase.to_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span>  <span class="c1"># pylint: disable=arguments-differ</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rootfolder</span><span class="o">=</span><span class="s2">&quot;/tmp/&quot;</span><span class="p">,</span>
        <span class="n">casename</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
        <span class="n">caseuser</span><span class="o">=</span><span class="s2">&quot;nn&quot;</span><span class="p">,</span>
        <span class="n">restart_from</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export the case metadata to file, e.g. when ERT run.</span>

<span class="sd">        This will be the configuration file and output the data necessary to</span>
<span class="sd">        generate a general case ID, typically done as a hook workflow in ERT</span>
<span class="sd">        or similar.</span>

<span class="sd">        Args:</span>
<span class="sd">            rootfolder: The folder root of case, e.g. /scratch/fmu/user/mycase</span>
<span class="sd">            casename: Name of case (run), e.g. &#39;mycase&#39;</span>
<span class="sd">            caseuser: The username fro the case, e.g. the &lt;USER&gt; in ERT</span>
<span class="sd">            restart_from: The uid of iteration from whci to run from</span>
<span class="sd">            description: A free-form description for case</span>

<span class="sd">        This will make an communication point to storage in cloud::</span>

<span class="sd">            case = InitializeCase(config=configdict)</span>
<span class="sd">            case.to_file(rootfolder=somefolder, caseuser=some_user)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_establish_fmu_case_metadata</span><span class="p">(</span>
            <span class="n">caseuser</span><span class="o">=</span><span class="n">caseuser</span><span class="p">,</span>
            <span class="n">casename</span><span class="o">=</span><span class="n">casename</span><span class="p">,</span>
            <span class="n">restart_from</span><span class="o">=</span><span class="n">restart_from</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">casefolder</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">rootfolder</span><span class="p">)</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">case_folder</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;C_META is:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">c_meta</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;case_folder:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">casefolder</span><span class="p">)</span>

        <span class="c1"># write to file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_case_metadata</span><span class="p">(</span><span class="n">casefolder</span><span class="p">,</span> <span class="n">c_meta</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright Equinor 2021 (fmu-dataio release 0.4.1.dev5+g0af3599).

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>